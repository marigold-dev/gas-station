<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Gas Station Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="marigold-docs-theme/marigold.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="welcome.html">Welcome</a></li><li class="chapter-item expanded affix "><a href="webapp.html">Gas Station Webapp</a></li><li class="chapter-item expanded affix "><a href="library.html">SDKs</a></li><li class="chapter-item expanded affix "><a href="api.html">API</a></li><li class="chapter-item expanded affix "><a href="tutorial.html">Tutorial</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Gas Station Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/marigold-dev/gas-station" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="welcome-on-gas-station"><a class="header" href="#welcome-on-gas-station">Welcome on Gas Station</a></h1>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p>The Gas Station is a tool designed for developers aiming to provide sponsored transactions to their users. It can be used to facilitate user onboarding or implementing a specific economic model (e.g., the user can mint a NFT freely, but pays a fee when reselling it).</p>
<p>The Gas Station would typically be used by video game developers seeking to subsidize activities for users without any tez in their wallets. It does not require these users to do any transaction or reveal their account, as the Gas Station account independently processes those transactions. However, it's important to note that this workflow may necessitate the use of specific smart contract patterns, such as permit (TZIP 17).</p>
<p>Currently, the API URL for Ghostnet is: https://ghostnet.gas-station-api.marigold.dev. The Gas Station is not yet available on the Mainnet.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="gas-station-webapp"><a class="header" href="#gas-station-webapp">Gas Station Webapp</a></h1>
<p>To enhance the user experience with the Gas Station, particularly in interacting with contracts and managing the budget for fee payments, we have developed a web app, available <a href="https://ghostnet.gas-station.marigold.dev/">here</a>.</p>
<p>⚠️ Note: currently available only on Ghostnet ⚠️</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<h3 id="wallet-connection"><a class="header" href="#wallet-connection">Wallet connection</a></h3>
<p>Like all dApps, one of the first things to do is connect your wallet by clicking on the button in the top right corner.</p>
<p><img src="./assets/wallet_connection.png" alt="Wallet connection" /></p>
<h3 id="your-contracts"><a class="header" href="#your-contracts">Your contracts</a></h3>
<p>On the homepage, you can find all your contracts registered on the Gas Station along with their activated entrypoints.</p>
<p><img src="./assets/homepage.png" alt="Homepage" /></p>
<h3 id="add-a-new-contract"><a class="header" href="#add-a-new-contract">Add a new contract</a></h3>
<p>To add a new contract, click on <code>Add contract</code> and fill in the required information. Start by entering the contract address to retrieve the associated entrypoints for your contract. Then, provide a name and activate the entrypoints for which you want to sponsor.</p>
<p><img src="./assets/add-contract.png" alt="Add contract" /></p>
<h3 id="add-credits-to-your-vault"><a class="header" href="#add-credits-to-your-vault">Add credits to your vault</a></h3>
<p>To add credits to your vault, go to the <code>My credits</code> page. Enter the amount of XTZ you want to send to your vault and confirm. After a few seconds, your vault balance and overall balance will update, and the transfer will be effective.</p>
<p><img src="./assets/add-credits.png" alt="Add credits" /></p>
<h3 id="withdraw"><a class="header" href="#withdraw">Withdraw</a></h3>
<p>You can also withdraw XTZ from your vault. On the <code>My credits</code> page, enter the amount of XTZ you want to withdraw and confirm. You'll need to sign the transaction with your wallet to ensure that the credits go to the correct address.</p>
<h3 id="test"><a class="header" href="#test">Test</a></h3>
<p>Once the contract is added and credits are transferred to your vault, you can integrate the Gas Station into your dApps by following this <a href="./tutorial.html">guide</a>. This will allow you to test the seamless integration of the Gas Station with your dApps.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sdks"><a class="header" href="#sdks">SDKs</a></h1>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting started</a></h2>
<p>To enhance the user experience, we have developed two SDKs (for now) to integrate into your web applications. They will facilitate easy interaction with the Gas Station. Currently, we have developed an SDK for Typescript and another one for Unity.</p>
<h3 id="typescript"><a class="header" href="#typescript">Typescript</a></h3>
<h4 id="installation"><a class="header" href="#installation">Installation</a></h4>
<p>To install the Typescript SDK, run :</p>
<pre><code class="language-bash">npm install --save @marigold-dev/gas-station-lib
</code></pre>
<h4 id="explanations"><a class="header" href="#explanations">Explanations</a></h4>
<p>The SDK consists of two classes : <code>GasStation</code> and <code>PermitContract</code>.</p>
<p>The <code>GasStation</code> class enables easy communication with the Gas Station API without the need to manually initialize the HTTP request.</p>
<p>To initialize this class, you need to provide it with a Gas Station API URL. For now, you can use <code>https://gas-station-api.marigold.dev/operation</code>.</p>
<p>The class has two methods:</p>
<ul>
<li><code>postOperation</code> takes a <code>sender</code> parameter (usually the user's address) and an <code>operation</code> of the following type:</li>
</ul>
<pre><code class="language-ts">export type Operation = {
  destination: string;
  parameters: unknown;
};
</code></pre>
<p>This method then prepares the HTTP request and sends it to the <code>/operation</code> endpoint of the API, which processes the operation.</p>
<ul>
<li><code>postOperations</code> also takes a <code>sender</code> and an array of <code>Operation</code>, allowing you to send multiple operations at once.</li>
</ul>
<p>The <code>PermitContract</code> class allows the generation of a permit <a href="https://tzip.tezosagora.org/proposal/tzip-17">TZIP-17</a> for a given contract.</p>
<blockquote>
<p>A permit is an authorization to call a specific endpoint of a smart contract with a specified parameter on behalf of a given address. This authorization may have an expiration. It is particularly useful for handling FA tokens when the user has ownership (transfer, update_operation, approve).</p>
</blockquote>
<p>This class has two methods:</p>
<ul>
<li><code>generatePermit</code> creates a permit from a transfer operation. It returns an object containing:</li>
</ul>
<pre><code class="language-ts">{
  bytes: string, // les bytes contenant le permis
  transfer_hash: string, // le hash de l'operation de transfet
}
</code></pre>
<p>After calling <code>generatePermit</code>, you need to have the token owner sign the bytes to finalize the permit.</p>
<ul>
<li><code>permitCall</code> allows calling the <code>permit</code> entrypoint on the target contract. This registers the permit in the contract storage (refer to <a href="https://tzip.tezosagora.org/proposal/tzip-17">TZIP-17</a>). This method takes an object of type:</li>
</ul>
<pre><code class="language-ts">type PermitOperation = {
  publicKey: string;
  signature: string;
  transferHash: string;
};
</code></pre>
<p>and returns an operation of type <code>TransferParams</code>.</p>
<h4 id="usage-1"><a class="header" href="#usage-1">Usage</a></h4>
<p>To begin, you need to import and initialize the <code>GasStation</code> object from the SDK:</p>
<pre><code class="language-ts">import { GasStation } from '@marigold-dev/gas-station-lib'

const gasApi = new GasStation({
  apiURL: 'https://gas-station-api.marigold.dev/'
})
</code></pre>
<p>Next, you can forge your operation, for example, to mint an NFT (assuming the contract has a <code>mint_token</code> entrypoint):</p>
<pre><code class="language-ts">const mintOperation = await contract.methodsObject.mint_token([{
              owner: userAddress,
              token_id: tokenId,
              amount_: 1
          }]).toTransferParams()
</code></pre>
<p>Finally, you can send your operation to the Gas Station with:</p>
<pre><code class="language-ts">const response = await gasApi.postOperation(userAddress, {
            destination: mintOperation.to,
            parameters: mintOperation.parameter
          });
</code></pre>
<h3 id="unity"><a class="header" href="#unity">Unity</a></h3>
<p>🚧 Work in Progress 🚧</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="api"><a class="header" href="#api">API</a></h1>
<p>You can find API specifications <a href="https://ghostnet.gas-station-api.marigold.dev/docs">here</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="tutorial"><a class="header" href="#tutorial">Tutorial</a></h1>
<p>To understand the potential and how to use the Gas Station, let's walk through the simple example of NFTs available at this <a href="https://ghostnet.gas-station-nft-example.marigold.dev">address</a>.</p>
<h2 id="template"><a class="header" href="#template">Template</a></h2>
<p>The first step is to retrieve the code template located <a href="https://github.com/marigold-dev/gas-station-lib">here</a>.
Once retrieved, you can run the following commands:</p>
<pre><code>npm install
npm run check
</code></pre>
<p>To test that everything works well, you can use:</p>
<pre><code>npm run dev
</code></pre>
<p>The files of interest are located in <code>src/lib</code>. You will find Svelte components and a <code>tezos.ts</code> file that contains utility functions such as wallet connection, etc.</p>
<h2 id="minting"><a class="header" href="#minting">Minting</a></h2>
<p>We'll start with minting an NFT by a user. The contract we'll use is available at this address on Ghostnet: <code>KT199yuNkHQKpy331A6fvWJtQ1uan9uya2jx</code>.
The goal here is for the user to initiate the mint action and retrieve their NFT without having to pay gas fees. For this, we will use the TypeScript SDK, and you can find more information <a href="./library.html">here</a>.</p>
<p>First, we'll setup the GasStation SDK as follows:</p>
<pre><code class="language-ts">const gasStationAPI = new GasStation({
  apiURL: PUBLIC_GAS_STATION_API
})
</code></pre>
<p>ℹ️ <code>PUBLIC_GAS_STATION_API</code> is an environment variable available in <code>.env</code></p>
<p>Next, we'll retrieve an instance of our contract, using <a href="https://tezostaquito.io/">Taquito</a>.</p>
<pre><code class="language-ts">const contract = await Tezos.wallet.at(PUBLIC_PERMIT_CONTRACT);
</code></pre>
<p>ℹ️ The <code>Tezos</code> instance of Taquito is already initialized in the <code>tezos.ts</code> file, so it can be directly imported.</p>
<p>ℹ️ <code>PUBLIC_PERMIT_CONTRACT</code> is also an environment variable corresponding to the address of your NFT contract.</p>
<p>Afterward, we will forge our operation to send to the Gas Station:</p>
<pre><code class="language-ts">const mintOperation = await contract.methodsObject.mint_token([{
              owner: userAddress,
              token_id: 0,
              amount_: 1
          }]).toTransferParams()
</code></pre>
<p>Using Taquito, we forge a transfer operation on the <code>mint_token</code> entrypoint.
The parameters for this entrypoint are:</p>
<ul>
<li><code>owner</code> : the future owner of the NFT</li>
<li><code>token_id</code> : l'ID of the token (NFT) that we are going to mint</li>
<li><code>amount_</code> : the quantity of tokens we want to mint.</li>
</ul>
<p>Finally, once the operation is forged, we can send it to the Gas Station API:</p>
<pre><code class="language-ts">const response = await gasStationAPI.postOperation(userAddress, {
            destination: mintOperation.to,
            parameters: mintOperation.parameter
          });
</code></pre>
<p>The operation will take a few seconds to be processed by the Gas Station (usually 12/15 seconds) if everything is correct.
If an error occurs (insufficient funds, authorization issue for minting the NFT, etc.), an error code will be returned, which you can handle in your dApp to inform the user.</p>
<h2 id="staking"><a class="header" href="#staking">Staking</a></h2>
<p>For staking, we need a permit. Staking involves transferring our freshly minted NFT to the contract. As we own the NFT, it is appropriate to sign a permit (authorization) to perform this transfer.</p>
<p>To facilitate the development of this new feature, we will also use the TypeScript SDK (for reference, you have all the information <a href="./library.html">here</a>)</p>
<p>To start, let's initialize the <code>GasStation</code> and <code>PermitContract</code>  classes from the SDK:</p>
<pre><code class="language-ts">const gasStationApi = new GasStation({
        apiURL: PUBLIC_GAS_STATION_API
      });
const permitContract = new PermitContract(PUBLIC_PERMIT_CONTRACT, Tezos);
</code></pre>
<p>Now we can generate our permit using the <code>generatePermit</code> method:</p>
<pre><code class="language-ts">const permitData = await permitContract.generatePermit({
        from_: userAddress,
        txs: [{
          to_: PUBLIC_STAKING_CONTRACT,
          token_id,
          amount: 1
        }]
      });
</code></pre>
<p>Some explanations:</p>
<ul>
<li>The variable <code>PUBLIC_STAKING_CONTRACT</code> contains the address of the staking contract (available at this address <code>KT1MLMXwFEMcfByGbGcQ9ow3nsrQCkLbcRAu</code> on Ghostnet).</li>
<li>The <code>token_id</code> corresponds to the ID of the token you want to stake.</li>
</ul>
<p><code>permitData</code> then contains the hash of the permit <code>bytes</code> and the hash of transfer operation <code>transfer_hash</code>:</p>
<pre><code class="language-ts">{
    bytes: string;
    transfer_hash: string;
}
</code></pre>
<p>Next, we need to have the owner of the token sign this permit and retrieve the signature.</p>
<p>This is easily done using Taquito:</p>
<pre><code class="language-ts">const signature = (await (await wallet.client).requestSignPayload({
          signingType: SigningType.MICHELINE,
          payload: permit_data.bytes
      })).signature;
</code></pre>
<p>Once we have the signed permit, we can register it with the contract that implements the <code>permit</code> entrypoint.</p>
<p>Again, we can use the SDK for this:</p>
<pre><code class="language-ts">const permitOperation = await permitContract.permitCall({
          publicKey: activeAccount.publicKey,
          signature: signature,
          transferHash: permit_data.transfer_hash
      });
</code></pre>
<ul>
<li><code>publicKey</code> is the public key of the token's owner</li>
<li><code>signature</code> is the signature of the permit obtained in the previous step</li>
<li><code>transferHash</code> is the hash of the transfer operation returned during the permit creation</li>
</ul>
<p>At this point, we have all the necessary information regarding the permit. Now, we can forge the staking operation itself and send everything to the Gas Station.</p>
<p>To forge the staking operation, we follow the usual process: we retrieve the contract instance using Taquito and craft the operation to get the parameters.</p>
<pre><code class="language-ts">const stakingContract = await Tezos.wallet.at(PUBLIC_STAKING_CONTRACT);
const stakingOperation = await stakingContract.methods.stake(
        1,
        userAddress
      ).toTransferParams();
</code></pre>
<p>ℹ️ <code>PUBLIC_STAKING_CONTRACT</code> is an environment variable containing the contract's address implementing the staking contract.</p>
<p>All that remains is to send the operation to the Gas Station to have the gas fees covered:</p>
<pre><code class="language-ts">const response = await gasStationApi.postOperations(userAddress,
          [
            {
              destination: permitOperation.to,
              parameters: permitOperation.parameter
            },
            {
              destination: stakingOperation.to,
              parameters: stakingOperation.parameter
            }
          ]);
</code></pre>
<p>Here, we use <code>postOperations</code> to submit a batch of operations. This batch contains the operation to register the permit and the staking operation. When calling the staking contract's <code>stake</code> entrypoint, the permit will be revealed and consumed.</p>
<p>Similar to the minting operation, the Gas Station will respond in a few tens of seconds.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="editor.js"></script>
        <script src="mode-rust.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="marigold-docs-theme/marigold.js"></script>

        <script>
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>

    </div>
    </body>
</html>
