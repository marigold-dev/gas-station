<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Permits - Gas Station Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="marigold-docs-theme/marigold.css">

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="welcome.html">Welcome</a></li><li class="chapter-item expanded affix "><a href="webapp.html">Gas Station Webapp</a></li><li class="chapter-item expanded affix "><a href="library.html">SDKs</a></li><li class="chapter-item expanded affix "><a href="api.html">API</a></li><li class="chapter-item expanded affix "><a href="tutorial.html">Tutorial</a></li><li class="chapter-item expanded affix "><a href="permits.html" class="active">Permits</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Gas Station Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/marigold-dev/gas-station" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="an-introduction-to-off-chain-permits"><a class="header" href="#an-introduction-to-off-chain-permits">An introduction to off-chain permits</a></h1>
<p>In the <a href="./tutorial.html">Tutorial</a> chapter, we demonstrate how to transfer an NFT to a smart contract
through the Gas Station. However, an issue arises as the corresponding operation is ultimately going to be posted by the Gas
Station account. The concern is how the NFT contract will allow this transfer on behalf of the user.</p>
<p>FA2 contracts, used to implement NFTs, support the concept of <em>operator</em>
accounts acting on behalf of the user. However, only the original owner of the NFT can authorize a new operator to do so.
The simplest way would be to modify the NFT contract to:</p>
<ul>
<li>Make the Gas Station account a super-user of the contract.</li>
<li>Let this account <a href="https://tezostaquito.io/docs/fa2_parameters/#the-update_operators-entrypoint">register third-party contracts as
operators</a>, which
would allow the transfer to happen.</li>
</ul>
<p>This, of course, introduces a security (and potentially legal) concern. If the key of the Marigold
Gas Station account is stolen, multiple FA2 contracts could be compromised as a consequence.
On the other hand, users whose operations are sponsored are not expected to have any tez in their wallets,
preventing them from independently posting the <code>update_operator</code> call on-chain.</p>
<p>So, what is the solution?</p>
<h2 id="off-chain-permits"><a class="header" href="#off-chain-permits">Off-chain permits</a></h2>
<p>To address this problem securely, the concept of <em>off-chain permits</em> was introduced through <a href="https://tzip.tezosagora.org/proposal/tzip-17/">TZIP
17</a>. This enhancement extends the FA2 standard with several new
entrypoints. The most noteworthy one, aptly named <code>permit</code>, can be invoked by anyone. It anticipates a list of
authorizations for transfers that are signed by the respective owners. Importantly, these transfers are signed off-chain.
This implies that the application must prompt users for their signatures through conventional means, such as a
Beacon-compatible wallet. However, the obtained signature must then be stored and/or transmitted to this entrypoint by another account.</p>
<p>However, in most cases, these permits can be included in the same transaction as the call to the other contract,
as demonstrated in the previous chapter. When a permit is registered by the contract, it functions as a one-time
authorization for a transfer to a specific address, which can either be a contract or an implicit account.
The <code>transfer</code> entrypoint maintains the same interface as an ordinary FA2
contract and, naturally, supports the same interface as before, including regular operators. This implies
that regular users, who do not require their transactions to be relayed by the gas station, can always
utilize their assets in a normal, permissionless manner.</p>
<p>Let's define permits: they consist of signed bytes formed from 4 parameters:</p>
<ul>
<li>The chain identifier ensures that a permit signed for a given chain (such as Ghostnet) cannot be used on a different chain.</li>
<li>The address of the permit FA2 contract ensures that a permit signed for a particular NFT collection cannot be used on another one.</li>
<li>A counter (nonce) defined inside the contract ensures that a permit can only be used once.</li>
<li>Finally, a hash of the allowed operation, which is checked when the
transfer takes place.</li>
</ul>
<p>If you recall <a href="./tutorial.html">the previous chapter</a>, this byte string was computed by the library using the following call:</p>
<pre><code class="language-ts">const permitData = await permitContract.generatePermit({
  from_: userAddress,
  txs: [{
    to_: RECIPIENT,
    token_id,
    amount: 1
  }]
});
</code></pre>
<p>Indeed, forming it manually can be a little bit complicated, and the slightest error can cause the permit fail silently.</p>
<p>Once signed by the user, the permit can be registered in the contract by invoking the <code>permit</code>
entrypoint. This entrypoint expects a list of parameters of the form <code>(public_key, signature, transfer_hash)</code>
where <code>public_key</code> is the user's public key, necessary for verifying the <code>signature</code>. Notably, this
<code>signature</code> is computed from the entire byte string, not just the <code>transfer_hash</code>.</p>
<p>If you choose to compute permits manually, be mindful that they are actually generated by forming
the following pair: <code>((chain_identifier, contract_address), (contract_counter, transfer_hash))</code>.
It's advisble to refer to the documentation of the contract library you are using to ensure accuracy.</p>
<h2 id="how-to-deploy-a-permit-contract"><a class="header" href="#how-to-deploy-a-permit-contract">How to deploy a permit contract</a></h2>
<p>The most up-to-date implementation of TZIP 17-style permits is available in <a href="https://github.com/aguillon/permit-cameligo/">the permit-cameligo Ligo
package</a>, which is currently maintained outside of the
Ligo Package Registry website. To use it, it is recommended to clone the following repository and
utilize the Ligo compiler to install the dependencies:</p>
<pre><code class="language-bash">$ git clone https://github.com/aguillon/permit-cameligo
$ cd permit-cameligo/
$ make install
$ make compile
</code></pre>
<p>Note that the Makefile assumes that you are running the dockerized version of Ligo. If you want to use another one,
such as a local version, you can prefix the <code>make</code> commands with <code>ligo_compiler=ligo </code>. For example:</p>
<pre><code class="language-bash">$ ligo_compiler=ligo make install
$ ligo_compiler=ligo make compile
</code></pre>
<p>This installs the dependencies in <code>.ligo/</code>, and compiles the code, generating two files in <code>compiled/</code>.
The first file is a JSONized version of the second, which is ready to be deployed using the scripts in <code>deploy/</code>.
Alongside the compiled code, this script requires two additional files:
<code>deploy/metadata.json</code> containing the contract's metadata, and <code>deploy/.env</code> which holds the secret key and the RPC node information.</p>
<p>Let's create a minimal <code>deploy/metadata.json</code> file:</p>
<pre><code class="language-json">{
  &quot;name&quot;:&quot;Example&quot;,
  &quot;interfaces&quot;:[
    &quot;TZIP-12&quot;
  ]
}
</code></pre>
<p>Customize this file according to your requirements. If you only want to test the deployment script, you can
also utilize the pre-generated <code>deploy/metadata.json.dist</code> file and rename it to <code>deploy/metadata.json</code>.
Similarly, copy <code>deploy/.env.dist</code> to <code>deploy/.env</code> and edit the file to include your secret key:</p>
<pre><code class="language-bash"># Required: Your private key
PK=edsk...
# Required: see https://tezostaquito.io/docs/rpc_nodes/
RPC_URL=https://ghostnet.tezos.marigold.dev/
</code></pre>
<p>Finally, you should be able to</p>
<pre><code class="language-bash">$ cd deploy/
$ npm i
$ npm run start
</code></pre>
<p>This workflow assumes that you will mint each token individually by invoking the
<code>create_token</code> entrypoint. If you prefer to pre-mint some tokens, you will need to modify the
<code>deploy/deploy.ts</code> script to begin with a non-empty <code>token_metadata</code> map.
The script should output the address of the contract after origination.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="tutorial.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="tutorial.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="editor.js"></script>
        <script src="mode-rust.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="marigold-docs-theme/marigold.js"></script>


    </div>
    </body>
</html>
