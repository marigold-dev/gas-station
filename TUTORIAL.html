<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Tutorial - book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="WELCOME.html">Welcome</a></li><li class="chapter-item expanded affix "><a href="WEBAPP.html">Gas Station Webapp</a></li><li class="chapter-item expanded affix "><a href="LIBRARY.html">SDKs</a></li><li class="chapter-item expanded affix "><a href="API.html">API</a></li><li class="chapter-item expanded affix "><a href="TUTORIAL.html" class="active">Tutorial</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="tutorial"><a class="header" href="#tutorial">Tutorial</a></h1>
<p>Pour comprendre le potentiel et comment utiliser la Gas Station, nous allons reprendre l'exemple simple des NFT disponible à cette adresse : https://gas-station-nft-example.marigold.dev</p>
<h2 id="template"><a class="header" href="#template">Template</a></h2>
<p>La première chose à faire est de récupérer le template de code situé <a href="https://github.com/marigold-dev/gas-station-lib">ici</a>.
Une fois récupéré, vous pouvez run ces commandes :</p>
<pre><code>npm install
npm run check
</code></pre>
<p>Pour tester que tout se lance correctement, vous pouvez utilise</p>
<pre><code>npm run dev
</code></pre>
<p>Les fichiers qui vont nous intéressés se situent dans <code>src/lib</code>. Vous allez y trouver des composants en Svelte et un fichier <code>tezos.ts</code> qui regroupe des fonctions utilitaires comme la connexion au wallet, etc...</p>
<h2 id="minting"><a class="header" href="#minting">Minting</a></h2>
<p>Nous allons commencer par le mint d'un NFT par un utilisateur. Le contrat que nous allons utiliser est disponible à cette adresse sur Ghostnet : <code>KT199yuNkHQKpy331A6fvWJtQ1uan9uya2jx</code>
Le but ici est que l'utilisateur initie l'action de mint et puisse récupérer son NFT sans avoir à payer les frais de gas.
Pour cela nous allons utiliser le SDK Typescript dont vous pouvez retrouver les informations <a href="./LIBRARY.html">ici</a></p>
<p>D'abord nous allons initialiser le SDK GasStation comme suit:</p>
<pre><code class="language-ts">const gasStationAPI = new GasStation({
  apiURL: PUBLIC_GAS_STATION_API
})
</code></pre>
<p>:info: <code>PUBLIC_GAS_STATION_API</code> est une variable d'environnement disponible dans le fichier <code>.env</code></p>
<p>Ensuite nous allons récupérer une instance de notre contrat, à l'aide de <a href="taquito">Taquito</a>.</p>
<pre><code class="language-ts">const contract = await Tezos.wallet.at(PUBLIC_PERMIT);
</code></pre>
<p>:info: L'instance <code>Tezos</code> de Taquito est déjà initialisé dans le fichier <code>tezos.ts</code>, on peut donc directement l'importer.
:info: <code>PUBLIC_PERMIT</code> est également une variable d'environnement qui correspond à l'adresse de votre contrat de NFT</p>
<p>Après cela nous allons forger notre opération à envoyer à la Gas Station</p>
<pre><code class="language-ts">const mint_op = await contract.methodsObject.mint_token([{
              owner: user_address,
              token_id: 0, //TODO : Make the possibility to change token_id
              amount_: 1
          }]).toTransferParams()
</code></pre>
<p>A l'aide de Taquito, nous forgeons une opération de transfert sur l'entrypoint <code>mint_token</code>.
Les paramètres de cet entrypoint sont :</p>
<ul>
<li><code>owner</code> : le futur propriétaire du NFT</li>
<li><code>token_id</code> : l'ID du token (NFT) que nous allons minté (sur le contrat pointé au dessus, il y en a 6 disponibles)</li>
<li><code>amount_</code> : la quantité de tokens que nous voulons minté. Ici 1 seul est déjà suffisant.</li>
</ul>
<p>Enfin, une fois l'opération forgée, nous pouvons l'envoyer à l'API de la Gas Station :</p>
<pre><code class="language-ts">const response = await gasStationAPI.postOperation(user_address, {
            destination: mint_op.to,
            parameters: mint_op.parameter
          });
</code></pre>
<p>L'opération va mettre quelques secondes à être traitée par la Gas Station (généralement 12/15 secondes) si tout va bien. Si une erreur s'est produite (fonds insuffisants, problème d'autorisation pour mint le NFT...), un code d'erreur sera renvoyé, que vous pourrez traiter dans votre dApp pour informer l'utilisateur.</p>
<h2 id="staking"><a class="header" href="#staking">Staking</a></h2>
<p>Pour le staking, nous avons besoin d'un permis. En effet, le staking consiste à transférer notre NFT fraîchement minté vers le contrat. Comme le NFT nous appartient, il convient de signer un permis (une autorisation) pour pouvoir effectuer ce transfert.</p>
<p>Pour faciliter le développement de cette nouvelle feature, nous allons également utiliser le SDK Typescript (pour rappel, vous avez toutes les informations <a href="./LIBRARY.html">ici</a>)</p>
<p>Pour commencer, nous allons initialiser les classes <code>GasStation</code> et <code>PermitContract</code> du SDK :</p>
<pre><code class="language-ts">const gasStationApi = new GasStation({
        apiURL: PUBLIC_GAS_STATION_API
      });
const permitContract = new PermitContract(PUBLIC_PERMIT, Tezos);
</code></pre>
<p>Maintenant nous pouvons générer notre permis à l'aide de la méthode <code>generatePermit</code> :</p>
<pre><code class="language-ts">const permit_data = await permit_contract.generatePermit({
        from_: user_address,
        txs: [{
          to_: PUBLIC_STAKING_CONTRACT,
          token_id,
          amount: 1
        }]
      });
</code></pre>
<p>Quelques explications :</p>
<ul>
<li>La variable <code>PUBLIC_STAKING_CONTRACT</code> contient l'adresse du contrat de staking (disponible à cette adresse <code>KT1MLMXwFEMcfByGbGcQ9ow3nsrQCkLbcRAu</code> sur Ghostnet)</li>
<li>Le <code>token_id</code> correspond à l'ID du token que vous voulez stake</li>
</ul>
<p><code>permit_data</code> contient alors le hash du permis <code>bytes</code> et le hash de l'opération de transfert <code>transfer_hash</code></p>
<pre><code class="language-ts">{
    bytes: string;
    transfer_hash: string;
}
</code></pre>
<p>On doit ensuite faire signer ce permis par l'utilisateur propriétaire du token et récupérer cette signature.</p>
<p>Cela se fait facilement à l'aide de Taquito :</p>
<pre><code class="language-ts">const signature = (await (await wallet.client).requestSignPayload({
          signingType: SigningType.MICHELINE,
          payload: permit_data.bytes
      })).signature;
</code></pre>
<p>Une fois que nous avons le permis signé, nous pouvons l'enregistrer auprès du contrat qui implémente l'entrypoint <code>permit</code>.</p>
<p>On va encore pouvoir utiliser le SDK pour faire cela :</p>
<pre><code class="language-ts">const permit_op = await permit_contract.permitCall({
          publicKey: activeAccount.publicKey,
          signature: signature,
          transferHash: permit_data.transfer_hash
      });
</code></pre>
<ul>
<li>publicKey est la clé publique du propriétaire du token</li>
<li>signature est la signature du permis récupérée à l'étape précédente</li>
<li>transferHash est le hash de l'opération de transfert renvoyé lors de la création du permis</li>
</ul>
<p>A ce stade, nous avons toutes les informations nécessaires concernant le permis. Nous allons maintenant pouvoir forgé l'opération de staking à proprement parler et envoyer le tout à la Gas Station.</p>
<p>Pour forger l'opération de staking, on fait comme d'habitude, on récupère l'instance du contrat à l'aide de Taquito et l'on craft l'opération pour récupérer les paramètres.</p>
<pre><code class="language-ts">const staking_contract = await Tezos.wallet.at(PUBLIC_STAKING_CONTRACT);
const staking_op = await staking_contract.methods.stake(
        1,
        user_address
      ).toTransferParams();
</code></pre>
<p>:info: <code>PUBLIC_STAKING_CONTRACT</code> est une variable d'environnement contenant l'adresse du contrat implémentant l'entrypoint de staking</p>
<p>Il ne nous reste plus qu'à envoyer l'opération à la Gas Station afin que les frais de gas soient payés :</p>
<pre><code class="language-ts">const response = await gas_api.postOperations(user_address,
          [
            {
              destination: permit_op.to,
              parameters: permit_op.parameter
            },
            {
              destination: staking_op.to,
              parameters: staking_op.parameter
            }
          ]);
</code></pre>
<p>Ici on utilise <code>postOperations</code> pour poster un batch d'opérations. Ce batch contient l'opération pour enregistrer le permis et l'opération de staking.
Lorsque l'on appelera l'entrypoint <code>stake</code> du contrat de staking, le permis sera revélé et consommé.</p>
<p>Comme pour l'opération de mint, la Gas Station répondra en qq dizaines de secondes.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="API.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="API.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
